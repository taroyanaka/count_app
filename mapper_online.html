<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Map with Pins</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 100vh; width: 100vw; } /* Full viewport width and height */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            cursor: pointer;
        }
        #zoomToLocation {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 20px; /* Increased padding for larger button */
            border: 2px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em; /* Increased font size */
        }
        #textAreaContainer {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            width: calc(100% - 40px);
            max-width: 600px;
        }
        #textAreaContainer textarea {
            width: 100%;
            height: 100px;
            box-sizing: border-box;
        }
        #clearButton {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            background: #f5f5f5;
        }
        #initDatabase {
            position: absolute;
            bottom: 120px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            display: none; /* Initially hidden */
        }
        #errorMessage {
            position: absolute;
            bottom: 10px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border: 2px solid #f00;
            border-radius: 5px;
            color: #f00;
            max-width: calc(100% - 40px);
            width: 100%;
            max-height: 100px;
            overflow-y: auto;
            display: none; /* Initially hidden */
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="map"></div>
        <button id="zoomToLocation">Zoom to Current Location</button>
        <div id="textAreaContainer">
            <textarea id="pinText"
            placeholder="type your text here"
                minlength="1" maxlength="300"
                v-model="textAreaValue"
            ></textarea>
            <button id="clearButton">Clear</button>
        </div>
        <button id="initDatabase">Initialize Database</button>
        <div id="errorMessage">{{ errorMessage }}</div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const app = Vue.createApp({
            data() {
                return {
                    map: null,
                    savedPins: [],
                    textArea: null,
                    textAreaValue: `[Hours]9:00-18:00
[Washlet]◯×
[Cleanliness Rating]/5
[In Shop]◯×
[1-line Comment]`,
                    clearButton: null,
                    zoomToLocationButton: null,
                    initDatabaseButton: null,
                    errorMessage: '', // Error message data
                    endpoint: 'https://cotton-concrete-catsup.glitch.me' // Set the API endpoint here
                };
            },
            mounted() {
                try {
                    this.textArea = document.getElementById('pinText');
                    this.clearButton = document.getElementById('clearButton');
                    this.zoomToLocationButton = document.getElementById('zoomToLocation');
                    this.initDatabaseButton = document.getElementById('initDatabase');
                    
                    this.initializeMap();
                    this.loadMarkers().catch(error => {
                        this.showError('Error loading pins: ' + error.message);
                    });
                    this.addEventListeners();
                } catch (error) {
                    this.showError('Error mounting app: ' + error.message);
                }
            },
            methods: {
                initializeMap() {
                    this.map = L.map('map').setView([35.681382, 139.766084], 13); // Tokyo Station coordinates

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(this.map);

                    this.map.on('click', this.addMarkerOnClick);
                },
                addMarker(lat, lng, text) {
                    const marker = L.marker([lat, lng]).addTo(this.map);
                    marker.bindPopup(`${text}<br><button onclick="app.deleteMarker(${lat}, ${lng})">Delete</button>`).openPopup();
                    return marker;
                },
                async addMarkerOnClick(e) {
                    try {
                        if (this.textArea) {
                            const latlng = e.latlng;
                            const text = this.textArea.value;

                            // Check text length
                            if (text.length === 0) {
                                this.showError('Text area cannot be empty.');
                                return;
                            } else if (text.length > 300) {
                                this.showError('Text area content exceeds 300 characters.');
                                return;
                            }

                            this.addMarker(latlng.lat, latlng.lng, text);
                            await this.savePin(latlng.lat, latlng.lng, text);
                        } else {
                            this.showError('TextArea is not available.');
                        }
                    } catch (error) {
                        this.showError('Error adding marker: ' + error.message);
                    }
                },
                async loadMarkers() {
                    try {
                        const response = await fetch(`${this.endpoint}/api/pins`);
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }

                        const pins = await response.json();
                        
                        if (Array.isArray(pins)) {
                            this.savedPins = pins;
                            this.savedPins.forEach(pin => {
                                this.addMarker(pin.lat, pin.lng, pin.text);
                            });
                        } else {
                            throw new Error('Fetched data is not an array.');
                        }
                    } catch (error) {
                        this.showError('Error loading pins: ' + error.message);
                    }
                },
                async savePin(lat, lng, text) {
                    try {
                        const response = await fetch(`${this.endpoint}/api/pins`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ lat, lng, text })
                        });
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        const data = await response.json();
                        this.savedPins.push(data);
                    } catch (error) {
                        this.showError('Error saving pin: ' + error.message);
                    }
                },
                async deleteMarker(lat, lng) {
                    try {
                        const response = await fetch(`${this.endpoint}/api/pins/${lat}`, {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            this.savedPins = this.savedPins.filter(pin => !(pin.lat === lat && pin.lng === lng));
                            this.map.eachLayer(layer => {
                                if (layer instanceof L.Marker) {
                                    if (layer.getLatLng().lat === lat && layer.getLatLng().lng === lng) {
                                        this.map.removeLayer(layer);
                                    }
                                }
                            });
                        } else {
                            throw new Error('Error deleting pin from the server.');
                        }
                    } catch (error) {
                        this.showError('Error deleting pin: ' + error.message);
                    }
                },
                async zoomToLocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
                            this.map.setView(latlng, 15);
                        }, () => {
                            this.showError('Unable to retrieve your location.');
                        });
                    } else {
                        this.showError('Your browser does not support geolocation.');
                    }
                },
                async initializeDatabase() {
                    const password = prompt('Enter the password to initialize the database:');
                    if (password) {
                        try {
                            const response = await fetch(`${this.endpoint}/api/init`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ password })
                            });
                            const result = await response.json();
                            if (response.ok) {
                                alert(result.message);
                            } else {
                                this.showError(result.error);
                            }
                        } catch (error) {
                            this.showError('Error initializing database: ' + error.message);
                        }
                    }
                },
                showError(message) {
                    if (message.length > 300) {
                        message = message.slice(0, 300) + '...'; // Trim message to 300 characters
                    }
                    this.errorMessage = message;
                    document.getElementById('errorMessage').style.display = 'block';
                },
                addEventListeners() {
                    if (this.clearButton) {
                        this.clearButton.addEventListener('click', () => {
                            if (this.textArea) {
                                this.textArea.value = `[Hours]9:00-18:00
[Washlet]◯×
[Cleanliness Rating]/5
[In Shop]◯×
[1-line Comment]`;

                            } else {
                                this.showError('TextArea is not available.');
                            }
                        });
                    }
                    
                    if (this.zoomToLocationButton) {
                        this.zoomToLocationButton.addEventListener('click', this.zoomToLocation);
                    }

                    if (this.initDatabaseButton) {
                        this.initDatabaseButton.addEventListener('click', this.initializeDatabase);
                    }

                    this.map.on('click', this.addMarkerOnClick);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
